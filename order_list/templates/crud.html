{% extends "base.html" %}
{% load static %}
{% load extras %}
{% block stylesheets %}
<style>
    .resultoption {
        border: none;
        display: block;
        box-sizing: border-box;
    }
</style>
{% endblock stylesheets %}
{% block body %}
    <!-- side navbar -->
    {% include "navigation.html" %}
    <div class="main">

        <!--  top navbar  -->
        {% include "top-navigation.html" %}
        <main class="content">
            <div class="container-fluid">

                <div class="header" style="overflow: hidden; margin-bottom: 23px;">
                    <a class="sidebar-toggle d-flex mr-2" style="float: left; height: 32px; line-height: 32px;">
                        <i class="hamburger align-self-center"></i>
                    </a>
                    <h1 class="header-title" style="font-family: 'NanumSquareEB'; float: left;">
                        주문서 수정
                    </h1>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body">
                                <!-- 주문 접수자 / 주문일자 / 주문경로 -->
                                <div class="form-row">
                                    <div class="form-group col-md-4">
                                        <label for="employee_name">주문 접수자</label>
                                        <i class="align-middle mr-2 fas fa-fw fa-user-friends"></i>
                                        <select class="form-control select1" data-toggle="select1"
                                                id="employee" name="employee">
                                            {% for employee in member_table %}
                                                {% if employee.member_name == common.employee_name %}
                                                    <option selected>{{ employee.member_name }}</option>
                                                {% else %}
                                                    <option>{{ employee.member_name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="order_date">주문일자</label>
                                        <input type="date" class="form-control" id="order_date" name="order_date" value="{{ common.order_date|date:'Y-m-d' }}">
                                    </div>
                                    <div class="form-group col-md-4">
                                        <label for="order_type_name">주문경로</label>
                                        <select class="form-control select1" data-toggle="select1" id="order_type" name="order_type">
                                            {% for order_type in order_type_table %}
                                                {% if order_type.order_type_name == common.order_type_name %}
                                                    <option selected>{{ order_type.order_type_name }}</option>
                                                {% else %}
                                                    <option>{{ order_type.order_type_name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <!-- 고객명 / 연락처 / 수령방법 / 납품일자 / 도착시간 -->
                                <div class="form-row">
                                    <div class="form-group col-md-2">
                                        <label for="customer">고객명</label>
                                        <input type="text" class="form-control" id="customer" name="customer" autocomplete="off" value="{{ common.customer }}">
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="customer_phone">연락처</label>
                                        <input type="text" class="form-control" id="customer_phone" name="customer_phone" autocomplete="off" oninput="phone(this)" value="{{ common.customer_phone }}">
                                    </div>
                                    <div class="form-group col-md-2">
                                        <label for="delivery_option_name">수령 방법</label>
                                        <select class="form-control select1" data-toggle="select1"
                                                id="delivery" name="delivery">
                                            {% for delivery in delivery_table %}
                                                {% if delivery.delivery_name == common.delivery_option_name %}
                                                    <option selected>{{ delivery.delivery_name }}</option>
                                                {% else %}
                                                    <option>{{ delivery.delivery_name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="receipt_date">납품일자</label>
                                        <i class="align-middle mr-2 far fa-fw fa-calendar-alt"></i>
                                        <input type="date" class="form-control" id="currentDate2" name="receipt_date" value="{{ common.receipt_date|date:'Y-m-d' }}">
                                    </div>
                                    <div class="form-group col-md-2">
                                        <label for="receipt_hour">도착시간</label>
                                        <i class="align-middle mr-2 far fa-fw fa-clock"></i>
                                        <select class="form-control select1" data-toggle="select2"
                                                style="" id="receipt_hour" name="receipt_hour">
                                            <optgroup label="도착시간을 선택해주세요.">
                                                <option value="{{ common.receipt_hour|time }}" selected>{{ common.receipt_hour }}</option>
                                                <option value="07:00">7:00</option>
                                                <option value="07:30">7:30</option>
                                                <option value="08:00">8:00</option>
                                                <option value="08:30">8:30</option>
                                                <option value="09:00">9:00</option>
                                                <option value="09:30">9:30</option>
                                                <option value="10:00">10:00</option>
                                                <option value="10:30">10:30</option>
                                                <option value="11:00">11:00</option>
                                                <option value="11:30">11:30</option>
                                                <option value="12:00">12:00</option>
                                                <option value="12:30">12:30</option>
                                                <option value="13:00">13:00</option>
                                                <option value="13:30">13:30</option>
                                                <option value="14:00">14:00</option>
                                                <option value="14:30">14:30</option>
                                                <option value="15:00">15:00</option>
                                                <option value="15:30">15:30</option>
                                                <option value="16:00">16:00</option>
                                                <option value="16:30">16:30</option>
                                                <option value="17:00">17:00</option>
                                                <option value="17:30">17:30</option>
                                                <option value="18:00">18:00</option>
                                                <option value="18:30">18:30</option>
                                                <option value="19:00">19:00</option>
                                                <option value="19:30">19:30</option>
                                                <option value="20:00">20:00</option>
                                                <option value="20:30">20:30</option>
                                                <option value="21:00">21:00</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                </div>

                                <!-- 품목 -->
                                <div class="form-row">
                                    <div class="form-group col-md-3">
                                        <span>품목명</span>
                                    </div>
                                </div>

                                <!-- ============================================= -->
                                <div class="card" id="item-card">
                                    <div class="card-body">
                                        <div id="addproduct">
                                            {% for product in updatelist %}
                                                <div class="form-group row product" data-id="{{ forloop.counter }}" id="product_{{ forloop.counter }}">
                                                <button class="item-button addnumber" style="border-color: white;
                                                background-color: #153d77; color: white; padding: 0; width: 25px;" disabled>{{ forloop.counter }}</button>
                                                <div class="col-md">
                                                    <div class="input-group" style="float: left;">
                                                        <input type="hidden" class="product_no" id="pno_{{ forloop.counter }}" value="{{ product.pno }}">
                                                        <input data-id="{{ forloop.counter }}" type="text" id="products_{{ forloop.counter }}" class="form-control products" name="product_name"
                                                               style="font-family: 'NanumSquareR';" placeholder="품목이름" value="{{ product.product_name }}" disabled>
                                                        <span class="input-group-append">
                                                            <button type="button" class="btn item-button modalbtn"
                                                                    style="border-color: white; background-color: #153d77; color: white; float: left; margin-right: 10px;" data-id="{{ forloop.counter }}"
                                                                    data-toggle="modal" data-target="#sizedModalLg_{{ forloop.counter }}" id="modalbtn_{{ forloop.counter }}"
                                                                    onclick="clic(this);">
                                                                + 옵션추가
                                                            </button>
                                                        </span>
                                                    </div>
                                                </div>

                                                <div class="col-md" style="margin-right: 10px;">
                                                    <input type="text" class="form-control" placeholder="옵션이름"
                                                           id="input-option-result_{{ forloop.counter }}"
                                                           value="{{ product.size_option_name }} / {{ product.filling_option_name }} / {{ product.sheet_option_name }} / {{ product.boxing_option_name }} / {{ product.phrase }}" disabled>
                                                    <!-- 옵션 값 (Hidden) -->
                                                    <input type="text" hidden="hidden" id="size-result_{{ forloop.counter }}" value="{{ product.size_option_name }}" data-price="0">
                                                    <input type="text" hidden="hidden" id="filling-result_{{ forloop.counter }}" value="{{ product.filling_option_name }}" data-price="0">
                                                    <input type="text" hidden="hidden" id="sheet-result_{{ forloop.counter }}" value="{{ product.sheet_option_name }}" data-price="0">
                                                    <input type="text" hidden="hidden" id="boxing-result_{{ forloop.counter }}" value="{{ product.boxing_option_name }}" data-price="0">
                                                    <input type="text" hidden="hidden" id="phrase-result_{{ forloop.counter }}" value="{{ product.phrase }}" data-price="0">
                                                </div>
                                                <div class="col-md-1" style="padding-left: 0; margin-right: 10px;">
                                                    <input type="number" class="form-control count_product" data-id="{{ forloop.counter }}" id="count_{{ forloop.counter }}" placeholder="수량" min="1" value="{{ product.count }}" onchange="count(this);">
                                                </div>
                                                <button class="item-button" type="button" style="border-color: white;
                                                background-color: darkred; color: white; margin-right: 10px;" data-id="{{ forloop.counter }}" onclick="deleteproduct(this);">X</button>
                                                <div class="col-md-2">
                                                    <input type="hidden" data-price="" id="price_{{ forloop.counter }}" class="form-control" value="" readonly>
                                                    <input type="text" data-price="{{ product.product_price }}" id="priceone_{{ forloop.counter }}" class="form-control price1" value="{{ product.product_price }}" readonly>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>


                                        <!-- ============================================= -->

                                        <!-- 상품 추가 버튼 -->
                                        <div class="form-group row">
                                            <button type="button" class="btn btn-block" style="margin-top: 30px;
                                                 background-color: #153d77; color: white; width: 30%;" onclick="addproduct();">
                                                + 상품 추가
                                            </button>
                                        </div>
                                        <!-- 총 금액 표시 -->
                                        <div class="form-group row" style="float: right; clear: both;">
                                            <label style="padding-left: 20px;" class="col-form-label" for="">총</label>
                                            <div class="col-md-10">
                                                <input type="text" class="form-control" id="total_price" value="{{ product.total_price }}" readonly>
                                            </div>
                                        </div>

                                    </div>
                                </div>


                                <!-- 결제금액 / 결제여부 / 결제방법 -->
                                <div class="form-row">
                                    <div class="form-group col-md-3">
                                        <label for="inputCity">결제금액</label>
                                        <input type="text" name="total_price" class="form-control" id="pay_price" autocomplete="off" value="{{ common.total_price }}">
                                    </div>
                                    <!-- Radio Button result -->
                                    <input type="text" hidden="hidden" id="radio-result" name="radio-result">

                                    <div class="form-group col-md-4">
                                        <label for="order-root">결제 방법</label>
                                        <select class="form-control select1" data-toggle="select1"
                                                id="pay_type" name="pay_type">
                                            {% for pay in pay_type_table %}
                                                {% if pay.pay_type_name == common.pay_type_name %}
                                                    <option selected>{{pay.pay_type_name }}</option>
                                                {% else %}
                                                    <option>{{pay.pay_type_name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4" style="margin-bottom: 16px;">
                                        <label for="inputCity">결제여부</label>
                                        <div class="col-md-6" style="align-items: center;">
                                            {% if common.pay_check == 'O' %}
                                                <label class="form-check form-check-inline" style="margin-top: 8px; margin-right: 30px;">
                                                    <input class="form-check-input" type="radio" name="pay_check" value="O" data-value="O" checked>
                                                    <span class="form-check-label">완료</span>
                                                </label>
                                                <label class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="pay_check" value="X" data-value="X">
                                                    <span class="form-check-label">미완료</span>
                                                </label>
                                            {% elif common.pay_check == 'X' %}
                                                <label class="form-check form-check-inline" style="margin-top: 8px; margin-right: 30px;">
                                                    <input class="form-check-input" type="radio" name="pay_check" value="O" data-value="O">
                                                    <span class="form-check-label">완료</span>
                                                </label>
                                                <label class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="pay_check" value="X" data-value="X" checked>
                                                    <span class="form-check-label">미완료</span>
                                                </label>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <!-- 동일인 체크 -->
                                <div class="form-row" style="margin-top: 20px;">
                                    <div class="form-inline">
                                        <div class="custom-control custom-checkbox mb-1 mr-sm-2">
                                            {% if common.customer == common.recipient %}
                                                <input type="checkbox" class="custom-control-input" id="customControlInline" checked>
                                            {% else %}
                                                <input type="checkbox" class="custom-control-input" id="customControlInline">
                                            {% endif %}
                                            <label class="custom-control-label" for="customControlInline"
                                                   style="color: darkgray; font-size: 13px;">주문 고객과 동일</label>
                                        </div>
                                    </div>
                                </div>

                                <!-- 수령인명 / 수령인 연락처 -->
                                <div class="form-row" style="margin-top: 10px;">
                                    <div class="form-group col-md-3">
                                        <label for="inputCity">수령인명</label>
                                        <input type="text" name="recipient" class="form-control" id="recipient" autocomplete="off" oninput="customername(this);" value="{{ common.recipient }}">
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label for="inputCity">수령인 연락처</label>
                                        <input type="tel" name="recipient_phone" class="form-control" id="recipient_phone" autocomplete="off" oninput="phone(this);" value="{{ common.recipient_phone }}">
                                    </div>
                                </div>

                                <!-- 수령인 주소 -->
                                <div class="form-group row">
                                    <label style="padding-left: 12px;padding-right: 10px;"
                                           class="col-form-label" for="">수령인 주소</label>
                                    <!-- <button style="border-color: white;
                                            background-color: #0d8ddc; color: white">우편번호 검색</button> -->
                                    <div class="col-md-4">
                                        <input type="text" name="address1" class="form-control" id="address1" autocomplete="off" value="{{ common.address1 }}">
                                    </div>
                                    <div class="col-md-4" style="padding-left: 0;">
                                        <input type="text" name="address2" class="form-control" id="address2" autocomplete="off" value="{{ common.address2 }}">
                                    </div>
                                </div>

                                <!-- 주문메모 -->
                                <div class="form-row">
                                    <div class="form-group col-md-12">
                                        <label class="form-label">주문메모</label>
                                        <textarea style="width: 100%;" class="form-control" id="memo" name="memo" placeholder="메모 입력" rows="5" cols="">{{ common.memo }}</textarea>
                                    </div>
                                </div>

                                {% for one in info_price %}
                                    <input type="hidden" id="product_price_{{ forloop.counter }}" value="{{ one }}" />
                                {% endfor %}
                                {% for one in info_size %}
                                    <input type="hidden" id="size_price_{{ forloop.counter }}" value="{{ one }}" />
                                {% endfor %}
                                {% for one in info_sheet %}
                                    <input type="hidden" id="sheet_price_{{ forloop.counter }}" value="{{ one }}" />
                                {% endfor %}
                                {% for one in info_fill %}
                                    <input type="hidden" id="fill_price_{{ forloop.counter }}" value="{{ one }}" />
                                {% endfor %}
                                {% for one in info_box %}
                                    <input type="hidden" id="box_price_{{ forloop.counter }}" value="{{ one }}" />
                                {% endfor %}
                                {% for one in info_phrase %}
                                    <input type="hidden" id="phrase_price_{{ forloop.counter }}" value="{{ one }}" />
                                {% endfor %}

                                <!-- 주문 등록 버튼 -->
                                <div class="form-group row justify-content-center">
                                    <button type="submit" class="btn btn-lg" style="background-color: darkslategrey; color: white; width: 10%;" onclick="updateorder({{ pno }});">
                                        주문 등록
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- BEGIN  modal -->
                <div id="addmodal">
                    {% for product in updatelist %}
                        <div id="pmodal_{{ forloop.counter }}">
                            <div class="modal fade" id="sizedModalLg_{{ forloop.counter }}" tabindex="-1" role="dialog" aria-hidden="true" data-id="{{ forloop.counter }}">
                                <div class="modal-dialog modal-lg" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h2 style="font-family: 'NanumSquareB;" class="modal-title">옵션 선택</h2>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body m-3">
                                            <div class="form-group">
                                                <div class="form-floating">
                                                    <label for="inputCity">사이즈 옵션</label>
                                                    <select id="size-option_{{ forloop.counter }}" class="form-control mb-3 sizeoption" data-id="{{ forloop.counter }}" onchange="resize(this);">
                                                    </select>
                                                </div>

                                                <div class="form-floating">
                                                    <label for="inputCity">필링 옵션</label>
                                                    <select id="filling-option_{{ forloop.counter }}" class="form-control mb-3 fillingoption" data-id="{{ forloop.counter }}" onchange="refill(this);">
                                                        {% for filling in filling_table %}
                                                            {% if product.filling_option_name == filling.filling_name %}
                                                                <option data-price="{{ filling.filling_price }}" selected value="{{ filling.filling_name }}">{{ filling.filling_name }} : +{{ filling.filling_price }} </option>
                                                            {% else %}
                                                                <option data-price="{{ filling.filling_price }}" value="{{ filling.filling_name }}">{{ filling.filling_name }} : +{{ filling.filling_price }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <div class="form-floating">
                                                    <label for="inputCity">시트 옵션</label>
                                                    <select id="sheet-option_{{ forloop.counter }}" class="form-control mb-3 sheetoption" data-id="{{ forloop.counter }}" onchange="resheet(this);">
                                                        {% for sheet in sheet_table %}
                                                            {% if product.sheet_option_name == sheet.sheet_name %}
                                                                <option data-price="{{ sheet.sheet_price }}" value="{{ sheet.sheet_name }}" selected>{{ sheet.sheet_name }} : +{{ sheet.sheet_price }}</option>
                                                            {% else %}
                                                                <option data-price="{{ sheet.sheet_price }}" value="{{ sheet.sheet_name }}">{{ sheet.sheet_name }} : +{{ sheet.sheet_price }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <div class="form-floating">
                                                    <label for="inputCity">포장 옵션</label>
                                                    <select id="boxing-option_{{ forloop.counter }}" class="form-control mb-3 boxingoption" data-id="{{ forloop.counter }}" onchange="reboxing(this);">
                                                        {% for boxing in boxing_table %}
                                                            {% if product.boxing_option_name == boxing.boxing_name %}
                                                                <option data-price="{{ boxing.boxing_price }}" selected value="{{ boxing.boxing_name }}">{{ boxing.boxing_name }} : +{{ boxing.boxing_price }}</option>
                                                            {% else %}
                                                                <option data-price="{{ boxing.boxing_price }}" value="{{ boxing.boxing_name }}">{{ boxing.boxing_name }} : +{{ boxing.boxing_price }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <div class="form-floating">
                                                    <label for="inputCity">문구 옵션</label>
                                                    <input id="phrase-option_{{ forloop.counter }}" type="text" class="form-control phraseoption" value="{{ product.phrase }}" placeholder="문구없음" data-id="{{ forloop.counter }}" onkeyup="rephrase(this);">
                                                </div>
                                            </div>

                                            <div class="card" id="item-card">
                                                <div class="card-body">
                                                    <div class="form-row">
                                                        <div class="form-group col-md-12" style="margin-top: 16px;">
                                                            <div style="font-family: 'NanumSquareEB'; font-size: 15px;" id="option-result_{{ forloop.counter }}"></div>
                                                            <input type="hidden" id="numbering_{{ forloop.counter }}" value=""/>
                                                            <input type="hidden" data-price="0" id="product-price_{{ forloop.counter }}" value="0"/>
                                                            <input type="text" class="resultoption" id="div-size-result_{{ forloop.counter }}" data-price="0" value="{{ product.size_option_name }}" readonly/>
                                                            <input type="text" class="resultoption" id="div-filling-result_{{ forloop.counter }}" data-price="0" value="{{ product.filling_option_name }}" readonly/>
                                                            <input type="text" class="resultoption" id="div-sheet-result_{{ forloop.counter }}" data-price="0" value="{{ product.sheet_option_name }}" readonly/>
                                                            <input type="text" class="resultoption" id="div-boxing-result_{{ forloop.counter }}" data-price="0" value="{{ product.boxing_option_name }}" readonly/>
                                                            <input type="text" class="resultoption" id="div-phrase-result_{{ forloop.counter }}" data-price="0" value="{{ product.phrase }}" readonly/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                                            <button type="button" class="btn btn-primary final" id="final-option-result_{{ forloop.counter }}" data-id="{{ forloop.counter }}" onclick="confirmFix(this);">옵션 등록하기</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    <!-- END  modal -->
                </div>
            </div>
        </main>

        {% include "footer.html" %}
    </div>

{% endblock %}

{% block javascript %}

    {{ block.super }}
    <script src = "https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script type="text/javascript">


        // 첫 render시 디폴트 세팅
        defaultphone(); // 핸드폰 번호 하이픈
        defaultprice(); // 가격 설정
        pricesum(); // 가격 계산
        function defaultprice() {
            for(let i = 1; i <= {{ len }}; i++) {
                let size = document.getElementById(`size-result_${i}`);
                let fill = document.getElementById(`filling-result_${i}`);
                let sheet = document.getElementById(`sheet-result_${i}`);
                let box = document.getElementById(`boxing-result_${i}`);
                let phrase = document.getElementById(`phrase-result_${i}`);
                let product = document.getElementById(`product-price_${i}`);
                let count =  document.getElementById(`count_${i}`);

                let p_product = document.getElementById(`product_price_${i}`);
                let p_size = document.getElementById(`size_price_${i}`);
                let p_fill = document.getElementById(`fill_price_${i}`);
                let p_sheet = document.getElementById(`sheet_price_${i}`);
                let p_box = document.getElementById(`box_price_${i}`);
                let p_phrase = document.getElementById(`phrase_price_${i}`);

                product.value = p_product.value;
                size.dataset.price = p_size.value;
                fill.dataset.price = p_fill.value;
                sheet.dataset.price = p_sheet.value;
                box.dataset.price = p_box.value;
                phrase.dataset.price = p_phrase.value;

                let pricediv = document.getElementById(`price_${i}`);
                let total = parseInt(product.value) + parseInt(size.dataset.price)
                                + parseInt(fill.dataset.price) + parseInt(sheet.dataset.price)
                                + parseInt(box.dataset.price) + parseInt(phrase.dataset.price);
                let priceview = document.getElementById(`priceone_${i}`);
                pricediv.value = total;
                priceview.value = parseInt(total) * parseInt(count.value);
                priceview.value = priceview.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }
        }
        function defaultphone() {
            let customer_phone = document.getElementById(`customer_phone`);
            let recipient_phone = document.getElementById(`recipient_phone`);
            phone(customer_phone);
            phone(recipient_phone);
        }
        // =========================================================================
        class OrderList {
            constructor(emp, orderdate, ordertype, customer, customerphone, delivery,
                        receiptdate, receipthour, payprice, paycheck, paytype, recipient,
                        recipientphone, address1, address2, memo, productList) {
                this.emp = emp;
                this.order_date = orderdate;
                this.order_type = ordertype;
                this.customer = customer;
                this.customerphone = customerphone;
                this.delivery = delivery;
                this.receiptdate = receiptdate;
                this.receipthour = receipthour;
                this.payprice = payprice;
                this.paycheck = paycheck;
                this.paytype = paytype;
                this.recipient = recipient;
                this.recipientphone = recipientphone;
                this.address1 = address1;
                this.address2 = address2;
                this.memo = memo;
                this.productList = productList;
            }
            get productList() {
                return this._productList;
            }
            set productList(value) {
                this._productList = value;
            }
        }
        class Product {
            constructor(pno, name, size, fill, sheet, box, phrase, count, price) {
                this.pno = pno;
                this.name = name;
                this.size = size;
                this.fill = fill;
                this.sheet = sheet;
                this.box = box;
                this.phrase = phrase;
                this.count = count;
                this.price = price;
            }
        }
        // =========================================================================
        productList();
        function productList() {

            // 품목 리스트
            var productList = [];
            {% for product in products_table %}
                productList.push('{{ product.product_name }}')
            {% endfor %}

            // 카테고리 리스트
            var categoryMidList = [];
            {% for category in categories %}
                categoryMidList.push('{{ category.category_mid }}')
            {% endfor %}

            $(".products").autocomplete({
                source: productList,
                select: function(event, ui) {
                },
                focus: function(event, ui) {
                    return false;
                }
            });
        }
        // =========================================================================
        <!-- 비동기 처리를 위한 사전 처리 -->
        function getCookie(name) {
            console.log(1);
            let cookieValue = null;
            if(document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for(let i = 0; i < cookies.length; i++) {
                    let cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if(cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        var xhr;

        // =========================================================================

        // 고객명 공백입력 검증 - customer
        function customername(name) {
            name.value = name.value.replace(/[\s]/g, '');
        }

        // *** 고객 연락처 값 검증 - customer_phone
        function autoHypen(str) {
            str = str.replace(/[^0-9]/g, '');
            let tmp = '';
            if (str.length < 4) {
                return str;
            } else if (str.length < 7) {
                tmp += str.substr(0, 3);
                tmp += '-';
                tmp += str.substr(3);
                return tmp;
            } else if (str.length < 11) {
                tmp += str.substr(0, 3);
                tmp += '-';
                tmp += str.substr(3, 3);
                tmp += '-';
                tmp += str.substr(6);
                return tmp;
            } else {
                tmp += str.substr(0, 3);
                tmp += '-';
                tmp += str.substr(3, 4);
                tmp += '-';
                tmp += str.substr(7);
                return tmp;
            }
            return str;
        }
        function phone(number) {
            number.value = autoHypen(number.value);
            if (number.value.length >= 13) {
                number.value = number.value.substr(0, 13);
            }
        }
        // *** 주문고객 수령일 경우 체크
        let check = document.getElementById("customControlInline");
        check.addEventListener("click", function() {
            if(check.checked) {
                var customer = document.getElementById("customer").value;
                var phone = document.getElementById("customer_phone").value;
                document.getElementById("recipient").value = customer;
                document.getElementById("recipient_phone").value = phone;
            } else {
                document.getElementById("recipient").value = '';
                document.getElementById("recipient_phone").value = '';
            }
        });

        // *** 폼 검증
        function formConfirm(tag) {
            if(tag.value === '') {
                alert(`정보를 입력해주세요`);
                tag.focus();
                return 0;
            } else {
                return 1;
            }
        }
        // =========================================================================
        // 상품조회 함수

        const sqlAjax = async (name) => {
            let i;
            await $.ajax({
                url: '/list/option_view',
                type: "GET",
                dataType: "json",
                data: {
                    'name':name
                },
                contentType:'application/json; charset=utf-8',
                success: (response) => {
                    i = response;
                },
                error: (error) => {
                    console.log(error);
                }
            });
            return i;
        }

        async function sqlselect(id) {
            let product_name = document.getElementById(`products_${id}`);

            if (product_name.value === '') {
                alert('상품을 입력해주세요.');
                return {
                    size: '',
                    i: 0,
                    category: '',
                    price: 0
                };
            }
            const sql = await sqlAjax(product_name.value);

            let i = sql.flag;
            let size = sql.size;
            let category = sql.category;
            let price = sql.price;

            return {
                size: size,
                i: i,
                category: category,
                price: price
            };
        }
        // =========================================================================
        /*
        * 상품에 해당하는 size옵션을 모달영역에 지정하는 함수
        * 단일로는 동작할 수 없고 DB에서 상품 이름으로 조회한 size객체와
        * 몇번 상품의 옵션인가에 대한 id를 매개변수로 받음
        */
        function sizeset(size, id) {
            let sizediv = document.getElementById(`size-option_${id}`); // modal 사이즈 영역
            let opt = '';
            let sizeresult = document.getElementById(`div-size-result_${id}`); // modal 옵션 결과값 영역
            let finalsize = document.getElementById(`size-result_${id}`); // 최종 확정된 옵션값
            if(size.length === 0) {
                opt = `<option data-price=0 value=''>선택없음 : 0</option>`;
                sizediv.innerHTML = opt;
                sizediv.disabled = true;
                sizeresult.value = '선택없음';
                sizeresult.dataset.price = 0;
                finalsize.value = '선택없음';
                finalsize.dataset.price = 0;
            } else {
                if (finalsize.value !== '') {
                    for(let i = 0; i < size.length; i++) {
                        if (size[i].size_name === finalsize.value) {
                            opt += `<option data-price=${size[i].size_price} value=${size[i].size_name} selected>${size[i].size_name} : ${size[i].size_price}</option>`;
                            sizeresult.value = size[i].size_name;
                            sizeresult.dataset.price = size[i].size_price;
                            finalsize.value = size[i].size_name;
                            finalsize.dataset.price = size[i].size_price;
                        } else {
                            opt += `<option data-price=${size[i].size_price} value=${size[i].size_name}>${size[i].size_name} : ${size[i].size_price}</option>`;
                        }
                    }
                } else {
                    for(let i = 0; i < size.length; i++) {
                        opt += `<option data-price=${size[i].size_price} value=${size[i].size_name}>${size[i].size_name} : ${size[i].size_price}</option>`;
                    }
                    sizeresult.value = size[0].size_name;
                    sizeresult.dataset.price = size[0].size_price;
                    finalsize.value = size[0].size_name;
                    finalsize.dataset.price = size[0].size_price;
                }
                sizediv.innerHTML = opt;
                sizediv.disabled = false;
            }
        }
        // 사이즈 옵션 변경시 설정값 변경
        function resize(e) {
            const id = e.dataset.id;
            let sizeoption = document.getElementById(`size-option_${id}`);
            let sizeoptionvalue = sizeoption.options[sizeoption.selectedIndex].value;
            let divsize = document.getElementById(`div-size-result_${id}`);
            let finalsize = document.getElementById(`size-result_${id}`);
            divsize.value = sizeoptionvalue;
            divsize.dataset.price = sizeoption.options[sizeoption.selectedIndex].dataset.price;
            finalsize.value = sizeoptionvalue;
            finalsize.dataset.price = sizeoption.options[sizeoption.selectedIndex].dataset.price;
        }
        // 필링 함수
        function fillset(category, id) {
            let filldiv = document.getElementById(`filling-option_${id}`); // modal fill 영역
            let opt = '';
            let fillresult = document.getElementById(`div-filling-result_${id}`); // modal 옵션 결과값 영역
            let finalfill = document.getElementById(`filling-result_${id}`); // 최종 확정된 옵션값

            if (category === '떡') {
                opt = `<option data-price=0 value=''>선택없음 : 0</option>`;
                filldiv.innerHTML = opt;
                filldiv.disabled = true;
                fillresult.value = '선택없음';
                fillresult.dataset.price = 0;
                finalfill.value = '선택없음';
                finalfill.dataset.price = 0;
            } else {
                if (finalfill.value !== '') {
                    {% for i in filling_table %}
                        if (finalfill.value === '{{ i.filling_name }}') {
                            opt += `<option data-price="{{ i.filling_price }}" value="{{ i.filling_name }}" selected>{{ i.filling_name }} : +{{ i.filling_price }}</option>`;
                            fillresult.value = '{{ i.filling_name }}';
                            fillresult.dataset.price = {{ i.filling_price }};
                            finalfill.value = '{{ i.filling_name }}';
                            finalfill.dataset.price = {{ i.filling_price }};
                        } else {
                            opt += `<option data-price="{{ i.filling_price }}" value="{{ i.filling_name }}">{{ i.filling_name }} : +{{ i.filling_price }}</option>`;
                        }
                    {% endfor %}
                } else {
                    {% for i in filling_table %}
                        opt += `<option data-price="{{ i.filling_price }}" value="{{ i.filling_name }}">{{ i.filling_name }} : +{{ i.filling_price }}</option>`;
                    {% endfor %}
                    fillresult.value = '{{ filling_first.filling_name }}';
                    fillresult.dataset.price = {{ filling_first.filling_price }};
                    finalfill.value = '{{ filling_first.filling_name }}';
                    finalfill.dataset.price = {{ filling_first.filling_price }};
                }
                filldiv.innerHTML = opt;
                filldiv.disabled = false;

            }
        }
        // 필링 옵션 변경시 설정값 변경
        function refill(e) {
            const id = e.dataset.id;
            let filloption = document.getElementById(`filling-option_${id}`);
            let filloptionvalue = filloption.options[filloption.selectedIndex].value;
            let divfill = document.getElementById(`div-filling-result_${id}`);
            let finalfill = document.getElementById(`filling-result_${id}`);
            divfill.value = filloptionvalue;
            divfill.dataset.price = filloption.options[filloption.selectedIndex].dataset.price;
            finalfill.value = filloptionvalue;
            finalfill.dataset.price = filloption.options[filloption.selectedIndex].dataset.price;
        }
        // 시트함수
        function sheetset(category, id) {
            let sheetdiv = document.getElementById(`sheet-option_${id}`); // modal fill 영역
            let opt = '';
            let sheetresult = document.getElementById(`div-sheet-result_${id}`); // modal 옵션 결과값 영역
            let finalsheet = document.getElementById(`sheet-result_${id}`); // 최종 확정된 옵션값
            if (category === '떡') {
                opt = `<option data-price=0 value=''>선택없음 : 0</option>`;
                sheetdiv.innerHTML = opt;
                sheetdiv.disabled = true;
                sheetresult.value = '선택없음';
                sheetresult.dataset.price = 0;
                finalsheet.value = '선택없음';
                finalsheet.dataset.price = 0;
            } else {
                if (finalsheet.value !== '') {
                    {% for i in sheet_table %}
                        if (finalsheet.value === '{{ i.sheet_name }}') {
                            opt += `<option data-price="{{ i.sheet_price }}" value="{{ i.sheet_name }}" selected>{{ i.sheet_name }} : +{{ i.sheet_price }}</option>`;
                            sheetresult.value = '{{ i.sheet_name }}';
                            sheetresult.dataset.price = {{ i.sheet_price }};
                            finalsheet.value = '{{ i.sheet_name }}';
                            finalsheet.dataset.price = {{ i.sheet_price }};
                        } else {
                            opt += `<option data-price="{{ i.sheet_price }}" value="{{ i.sheet_name }}">{{ i.sheet_name }} : +{{ i.sheet_price }}</option>`;
                        }
                    {% endfor %}
                } else {
                    {% for i in sheet_table %}
                        opt += `<option data-price="{{ i.sheet_price }}" value="{{ i.sheet_name }}">{{ i.sheet_name }} : +{{ i.sheet_price }}</option>`;
                    {% endfor %}
                    sheetresult.value = '{{ sheet_first.sheet_name }}';
                    sheetresult.dataset.price = {{ sheet_first.sheet_price }};
                    finalsheet.value = '{{ sheet_first.sheet_name }}';
                    finalsheet.dataset.price = {{ sheet_first.sheet_price }};
                }
                sheetdiv.innerHTML = opt;
                sheetdiv.disabled = false;

            }
        }
        // 시트 옵션 변경시 설정값 변경
        function resheet(e) {
            const id = e.dataset.id;
            let sheetoption = document.getElementById(`sheet-option_${id}`);
            let sheetoptionvalue = sheetoption.options[sheetoption.selectedIndex].value;
            let divsheet = document.getElementById(`div-sheet-result_${id}`);
            let finalsheet = document.getElementById(`sheet-result_${id}`);
            divsheet.value = sheetoptionvalue;
            divsheet.dataset.price = sheetoption.options[sheetoption.selectedIndex].dataset.price;
            finalsheet.value = sheetoptionvalue;
            finalsheet.dataset.price = sheetoption.options[sheetoption.selectedIndex].dataset.price;
        }
        // boxing함수
        function boxingset(id) {
            let boxingdiv = document.getElementById(`boxing-option_${id}`); // modal fill 영역
            let boxingresult = document.getElementById(`div-boxing-result_${id}`); // modal 옵션 결과값 영역
            let finalboxing = document.getElementById(`boxing-result_${id}`); // 최종 확정된 옵션값
            let opt;
            if (finalboxing.value !== '') {
                {% for i in boxing_table %}
                    if (finalboxing.value === '{{ i.boxing_name }}') {
                        opt += `<option data-price="{{ i.boxing_price }}" value="{{ i.boxing_name }}" selected>{{ i.boxing_name }} : +{{ i.boxing_price }}</option>`;
                        boxingresult.value = '{{ i.boxing_name }}';
                        boxingresult.dataset.price = {{ i.boxing_price }};
                        boxingresult.value = '{{ i.boxing_name }}';
                        boxingresult.dataset.price = {{ i.boxing_price }};
                    } else {
                        opt += `<option data-price="{{ i.boxing_price }}" value="{{ i.boxing_name }}">{{ i.boxing_name }} : +{{ i.boxing_price }}</option>`;
                    }
                {% endfor %}
            } else {
                boxingresult.value = '{{ boxing_first.boxing_name }}';
                boxingresult.dataset.price = {{ boxing_first.boxing_price }};
                finalboxing.value = '{{ boxing_first.boxing_name }}';
                finalboxing.dataset.price = {{ boxing_first.boxing_price }};
            }
        }
        // 포장 옵션 변경시 설정값 변경
        function reboxing(e) {
            const id = e.dataset.id;
            let boxingoption = document.getElementById(`boxing-option_${id}`);
            let boxingoptionvalue = boxingoption.options[boxingoption.selectedIndex].value;
            let divsheet = document.getElementById(`div-boxing-result_${id}`);
            let finalsheet = document.getElementById(`boxing-result_${id}`);
            divsheet.value = boxingoptionvalue;
            divsheet.dataset.price = boxingoption.options[boxingoption.selectedIndex].dataset.price;
            finalsheet.value = boxingoptionvalue;
            finalsheet.dataset.price = boxingoption.options[boxingoption.selectedIndex].dataset.price;
        }
        // 문구 처리 함수
        function phraseset(category, id) {
            let phrasediv = document.getElementById(`phrase-option_${id}`); // modal fill 영역
            let phraseresult = document.getElementById(`div-phrase-result_${id}`); // modal 옵션 결과값 영역
            let finalphrase = document.getElementById(`phrase-result_${id}`); // 최종 확정된 옵션값

            phraseresult.value = phrasediv.value;
            finalphrase.value = phrasediv.value;
            if (phrasediv.value === '') {
                phraseresult.value = '문구없음';
                phraseresult.dataset.price = 0;
                finalphrase.value = '문구없음';
                finalphrase.dataset.price = 0;
            } else {
                phraseresult.dataset.price = 5000;
                finalphrase.dataset.price = 5000;
            }
        }
        // 문구 변경시
        function rephrase(e) {
            const id = e.dataset.id;
            let phraseoption = document.getElementById(`phrase-option_${id}`);
            let phraseresult = document.getElementById(`div-phrase-result_${id}`);
            let finalphrase = document.getElementById(`phrase-result_${id}`);
            if (phraseoption.value === '') {
                phraseoption.dataset.price = 0;
                phraseresult.value = '문구없음';
                phraseresult.dataset.price = 0;
                finalphrase.value = '문구없음';
                finalphrase.dataset.price = 0;
            } else {
                phraseoption.dataset.price = 5000;
                phraseresult.value = phraseoption.value;
                phraseresult.dataset.price = 5000;
                finalphrase.value = phraseoption.value;
                finalphrase.dataset.price = 5000;
            }
        }
        // 옵션 등록
        function confirmFix(e) {
            let id = e.dataset.id;
            let size = document.getElementById(`size-result_${id}`);
            let fill = document.getElementById(`filling-result_${id}`);
            let sheet = document.getElementById(`sheet-result_${id}`);
            let box = document.getElementById(`boxing-result_${id}`);
            let phrase = document.getElementById(`phrase-result_${id}`);

            let product = parseInt(document.getElementById(`product-price_${id}`).value); // 상품 기본가격
            let price_s = parseInt(size.dataset.price);
            let price_f = parseInt(fill.dataset.price);
            let price_h = parseInt(sheet.dataset.price);
            let price_b = parseInt(box.dataset.price);
            let price_p = parseInt(phrase.dataset.price);

            let count = document.getElementById(`count_${id}`);
            if (count.value === '') {
                count.value = 1;
            }

            let pricecount = document.getElementById(`price_${id}`); // 합계 저장
            let priceview = document.getElementById(`priceone_${id}`); // * count 가 적용된 가격

            pricecount.value = product + price_s + price_f + price_h + price_b + price_p;
            let total = parseInt(pricecount.value) * parseInt(count.value);
            priceview.dataset.price = total;
            priceview.value = total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

            let finalresult = `${size.value} / ${fill.value} / ${sheet.value} / ${box.value} / ${phrase.value}`;
            let finaldiv = document.getElementById(`input-option-result_${id}`);
            finaldiv.value = finalresult;

            let products = document.getElementById(`products_${id}`);
            products.disabled = true;

            pricesum();
            $(`#sizedModalLg_${id}`).modal('hide');
        }
        // =========================================================================
        // 가격 계산
        // total price function
        function pricesum() {
            let pricetag = document.querySelectorAll('.price1');
            let totalprice = document.getElementById('total_price');
            let payprice = document.getElementById('pay_price');
            totalprice.value = 0;
            let a = 0;
            for(let i = 0; i < pricetag.length; i++) {
                let price = pricetag[i].value;
                a += parseInt(price.replace(/,/g, ''));
            }
            totalprice.value = a.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            payprice.value = totalprice.value;
        }
        // count updown
        function count(e) {
            let id = e.dataset.id;

            let count = document.getElementById(`count_${id}`).value;
            let pricediv = document.getElementById(`price_${id}`);
            let priceview = document.getElementById(`priceone_${id}`);

            pricediv.value = pricediv.value.replace(/,/g, '');
            let total = parseInt(pricediv.value) * parseInt(count);
            priceview.dataset.price = total;
            priceview.value = total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            pricesum();
        }
        // =========================================================================
        // 모달클래스가 열리기 전에 제어
        function clic(e) {
            let id = e.dataset.id;
            let price = document.getElementById(`product-price_${id}`);
            let result;
            let size;
            let category;
            let r_price;

            sqlselect(id).then((value) => {
                result = value.i;
                size = value.size;
                category = value.category;
                r_price = value.price;

                if (result === 0) { // 조회 결과가 없다면
                    e.dataset.target = '';
                } else if (result === 1) { // 조회값이 있다면
                    e.dataset.target = `#sizedModalLg_${id}`;
                    let update = document.getElementById(`products_${id}`);
                    sizeset(size, id);
                    fillset(category, id);
                    sheetset(category, id);
                    boxingset(id);
                    phraseset(category, id);
                    price.value = r_price;
                }
            });
        }
        // =========================================================================
        // 삭제할 주문번호 저장
        let deletenum = [];
        function deleteproduct(e) {
            const id = e.dataset.id;
            if (!confirm('삭제하시겠습니까?')) return false;
            let beforenum = document.querySelectorAll('.addnumber');
            let btnnum = beforenum.length;

            let productpage = document.getElementById(`product_${id}`);
            let modalpage = document.getElementById(`pmodal_${id}`);

            if (document.getElementById(`pno_${id}`) !== null){
                let pno = document.getElementById(`pno_${id}`);
                deletenum.push(pno.value);
            }

            if (btnnum === 1) {
                productpage.remove();
                modalpage.remove();
                addproduct();
            } else {
                productpage.remove();
                modalpage.remove();
            }

            let afternum = document.querySelectorAll('.addnumber');
            for(let i = 0; i < afternum.length; i++) {
                afternum[i].innerHTML = i + 1;
            }
            pricesum();

        }
        // =========================================================================
        function addproduct() {
            const max = 10;
            const count = document.querySelectorAll('.addnumber');
            const last = count.length;
            const current = last + 1;

            let lastnum;
            let slotnum;
            if (current === 1) {
                lastnum = 0;
                slotnum = 1;
            } else {
                lastnum = count[last - 1].parentNode;
                slotnum = lastnum.dataset.id * 1;
            }
            slotnum = slotnum + 1;

            if (current !== 1 && document.getElementById(`products_${slotnum - 1}`).disabled === false) {
                alert('상품등록을 완료해주세요');
                return false;
            }
            if (last >= max) {
                alert('상품은 10개까지 등록할 수 있습니다');
                return false;
            }

            // 상품 영역
            let str = '';
            str +=      `<button class="item-button addnumber" style="border-color: white; background-color: #153d77; color: white; padding: 0; width: 25px;" disabled>${current}</button>`;
            str +=      `<div class="col-md">`;
            str +=           `<div class="input-group" style="float:left;">`;
            str +=              `<input type="hidden" class="product_no" id="pno_${slotnum}" value="0">`;
            str +=              `<input data-id="${slotnum}" type="text" id="products_${slotnum}" class="form-control products" name="product_name" style="font-family: \'NanumSquareR\';" placeholder="품목이름">`;
            str +=              `<span class="input-group-append">`;
            str +=                  `<button type="button" class="btn item-button modalbtn"style="border-color: white;background-color: #153d77; color: white; float: left; margin-right: 10px;" data-id="${slotnum}" data-toggle="modal" data-target="#sizedModalLg_${slotnum}" id="modalbtn_${slotnum}" onclick="clic(this);">+ 옵션추가</button>`;
            str +=              '</span>';
            str +=          '</div>';
            str +=      '</div>';
            str +=      '<div class="col-md" style="margin-right: 10px;">';
            str +=          `<input type="text" class="form-control" placeholder="옵션이름" id="input-option-result_${slotnum}" disabled>`;
            str +=          `<input type="text" hidden="hidden" id="size-result_${slotnum}" data-price="0">`;
            str +=          `<input type="text" hidden="hidden" id="filling-result_${slotnum}" data-price="0">`;
            str +=          `<input type="text" hidden="hidden" id="sheet-result_${slotnum}" data-price="0">`;
            str +=          `<input type="text" hidden="hidden" id="boxing-result_${slotnum}" data-price="0">`;
            str +=          `<input type="text" hidden="hidden" id="phrase-result_${slotnum}" data-price="0">`;
            str +=      '</div>';
            str +=      '<div class="col-md-1" style="padding-left: 0; margin-right: 10px;">';
            str +=          `<input type="number" class="form-control count_product" data-id="${slotnum}" id="count_${slotnum}" placeholder="수량" min="1" onchange="count(this);">`;
            str +=      '</div>';
            str +=      `<button class="item-button" type="button" style="border-color: white; background-color: darkred; color: white; margin-right: 10px;" data-id="${slotnum}" onclick="deleteproduct(this);">X</button>`;
            str +=      '<div class="col-md-2">';
            str +=          `<input type="hidden" data-price="0" id="price_${slotnum}" class="form-control" value="0" readonly>`;
            str +=          `<input type="text" data-price="0" id="priceone_${slotnum}" class="form-control price1" value="0" readonly>`;
            str +=      '</div>';

            // 추가된 상품영역을 넣을 부모태그
            let addproduct = document.getElementById('addproduct');
            // 상품영역 생성
            let newdiv = document.createElement("div");
            newdiv.setAttribute("class", "form-group row product");
            newdiv.setAttribute("id", `product_${slotnum}`);
            newdiv.setAttribute("data-id", `${slotnum}`);
            newdiv.innerHTML = str;
            // 부모태그 종속
            addproduct.appendChild(newdiv);

            // 모달 생성
            let modal = "";
            modal += `<div class="modal fade" id="sizedModalLg_${slotnum}" tabindex="-1" role="dialog" aria-hidden="true" data-id="${slotnum}">`;
            modal += `<div class="modal-dialog modal-lg" role="document">`;
            modal += `<div class="modal-content">`;
            modal += `<div class="modal-header">`;
            modal += `<h2 style="font-family: \'NanumSquareB\';" class="modal-title">옵션 선택</h2>`;
            modal += `<button type="button" class="close" data-dismiss="modal" aria-label="Close">`;
            modal += `<span aria-hidden="true">&times;</span>`;
            modal += `</button>`;
            modal += `</div>`;
            modal += `<div class="modal-body m-3">`;
            modal += `<div class="form-group">`;
            modal += `<div class="form-floating">`;
            modal += `<label for="inputCity">사이즈 옵션</label>`;
            modal += `<select id="size-option_${slotnum}" class="form-control mb-3 sizeoption" data-id="${slotnum}" onchange="resize(this);"></select>`;
            modal += `</div>`;
            modal += `<div class="form-floating">`;
            modal += `<label for="inputCity">필링 옵션</label>`;
            modal += `<select id="filling-option_${slotnum}" class="form-control mb-3 fillingoption" data-id="${slotnum}" onchange="refill(this);">`;
            {% for filling in filling_table %}
                modal += `<option data-price="{{ filling.filling_price }}" value="{{ filling.filling_name }}">{{ filling.filling_name }} : +{{ filling.filling_price }}</option>`;
            {% endfor %}
            modal += `</select>`;
            modal += `</div>`;
            modal += `<div class="form-floating">`;
            modal += `<label for="inputCity">시트 옵션</label>`;
            modal += `<select id="sheet-option_${slotnum}" class="form-control mb-3 sheetoption" data-id="${slotnum}" onchange="resheet(this);">`;
            {% for sheet in sheet_table %}
                modal += `<option data-price="{{ sheet.sheet_price }}" value="{{ sheet.sheet_name }}">{{ sheet.sheet_name }} : +{{ sheet.sheet_price }}</option>`;
            {% endfor %}
            modal += `</select>`;
            modal += `</div>`;
            modal += `<div class="form-floating">`;
            modal += `<label for="inputCity">포장 옵션</label>`;
            modal += `<select id="boxing-option_${slotnum}" class="form-control mb-3 boxingoption" data-id="${slotnum}" onchange="reboxing(this);">`;
            {% for boxing in boxing_table %}
                modal += `<option data-price="{{ boxing.boxing_price }}" value="{{ boxing.boxing_name }}">{{ boxing.boxing_name }} : +{{ boxing.boxing_price }}</option>`;
            {% endfor %}
            modal += `</select>`;
            modal += `</div>`;
            modal += `<div class="form-floating">`;
            modal += `<label for="inputCity">문구 옵션</label>`;
            modal += `<input id="phrase-option_${slotnum}" type="text" class="form-control phraseoption" placeholder="문구없음" data-id="${slotnum}" data-price="0" onkeyup="rephrase(this);">`;
            modal += `</div>`;
            modal += `</div>`;
            modal += `<div class="card" id="item-card">`;
            modal += `<div class="card-body">`;
            modal += `<div class="form-row">`;
            modal += `<div class="form-group col-md-12" style="margin-top: 16px;">`;
            modal += `<div style="font-family: \'NanumSquareEB\'; font-size: 15px;" id="option-result_${slotnum}"></div>`;
            modal += `<input type="hidden" id="numbering_${slotnum}" value=""/>`;
            modal += `<input type="hidden" data-price="0" id="product-price_${slotnum}" value="0"/>`;
            modal += `<input type="text" class="resultoption" id="div-size-result_${slotnum}" data-price="0" value="선택없음" readonly/>`;
            modal += `<input type="text" class="resultoption" id="div-filling-result_${slotnum}" data-price="0" value="선택없음" readonly/>`;
            modal += `<input type="text" class="resultoption" id="div-sheet-result_${slotnum}" data-price="0" value="선택없음" readonly/>`;
            modal += `<input type="text" class="resultoption" id="div-boxing-result_${slotnum}" data-price="0" value="선택없음" readonly/>`;
            modal += `<input type="text" class="resultoption" id="div-phrase-result_${slotnum}" data-price="0" value="문구없음" readonly/>`;
            modal += `</div>`;
            modal += `</div>`;
            modal += `</div>`;
            modal += `</div>`;
            modal += `</div>`;
            modal += `<div class="modal-footer">`;
            modal += `<button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>`;
            modal += `<button type="button" class="btn btn-primary final" data-id="${slotnum}" id="final-option-result_${slotnum}" onclick="confirmFix(this);">옵션 등록하기</button>`;
            modal += `</div>`;
            modal += `</div>`;
            modal += `</div>`;
            modal += `</div>`;

            let addmodal = document.getElementById('addmodal');
            let newmodal = document.createElement('div');
            newmodal.setAttribute('id', `pmodal_${slotnum}`);
            newmodal.innerHTML = modal;
            addmodal.appendChild(newmodal);

            productList();

        }
        // =========================================================================

        function updateorder(currentPno) {
            event.preventDefault();

            let productnum = document.querySelectorAll('.product');
            let slot_count = productnum.length;

            let slotnum = [];
            for(let i = 0; i < slot_count; i++) {
                slotnum.push(productnum[i].dataset.id);
            }

            for(let i = 0; i < slotnum.length; i++) {
                let name = document.getElementById(`products_${slotnum[i]}`);
                if(name.value === '') {
                    alert('상품을 입력해주세요');
                    name.focus();
                    return false;
                }
            }
            // 수정할 주문번호
            let pnotag = document.querySelectorAll('.product_no');
            let pno = [];
            for(let i = 0; i < pnotag.length; i++) {
                pno.push(pnotag[i].value);
            }
            // 공통정보
            let emp = document.getElementById('employee').value;
            let order_date = document.getElementById('order_date').value;
            let order_type = document.getElementById('order_type').value;
            let customer = document.getElementById('customer');
            let customer_phone = document.getElementById('customer_phone');
            customer_phone.value = customer_phone.value.replace(/-/g, '');
            let delivery = document.getElementById('delivery').value;
            let receipt_date = document.getElementById('currentDate2');
            let receipt_hour = document.getElementById('receipt_hour').value;
            let pay_price = document.getElementById('pay_price');
            pay_price.value = pay_price.value.replace(/,/g, '');
            const radio_btn = document.getElementsByName('pay_check');
            let pay_check = "";
            radio_btn.forEach((node) => {
                if(node.checked) {
                    pay_check = node.value;
                }
            })
            let pay_type = document.getElementById('pay_type').value;
            let recipient = document.getElementById('recipient');
            let recipient_phone = document.getElementById('recipient_phone');
            recipient_phone.value = recipient_phone.value.replace(/-/g, '');
            let address1 = document.getElementById('address1').value;
            let address2 = document.getElementById('address2').value;
            let memo = document.getElementById('memo').value;

            let formList = [];
            formList.push(customer);
            formList.push(customer_phone);
            formList.push(receipt_date);
            formList.push(receipt_hour);
            formList.push(pay_price);
            formList.push(recipient);
            formList.push(recipient_phone);
            for(let i = 0; i < formList.length; i++) {
                if(formConfirm(formList[i]) === 0) {
                    return false;
                }
            }
            if(receipt_hour === '시간 선택') {
                alert('도착시간을 선택해주세요');
                return false;
            }
            if(!confirm('등록하시겠습니까?')) {
                return false;
            }

            let productList = [];
            for(let i = 0; i < slot_count; i++) {
                let pno = document.getElementById(`pno_${slotnum[i]}`).value;
                let product_name = document.getElementById(`products_${slotnum[i]}`);
                let size = document.getElementById(`size-result_${slotnum[i]}`).value;
                let filling = document.getElementById(`filling-result_${slotnum[i]}`).value;
                let sheet = document.getElementById(`sheet-result_${slotnum[i]}`).value;
                let boxing = document.getElementById(`boxing-result_${slotnum[i]}`).value;
                let phrase = document.getElementById(`phrase-result_${slotnum[i]}`).value;
                let count = document.getElementById(`count_${slotnum[i]}`).value;
                let product_price = document.getElementById(`price_${slotnum[i]}`).value;

                const product = new Product(pno, product_name.value, size, filling, sheet, boxing, phrase, count, product_price);
                productList.push(product);
            }
            const virtual_order = new OrderList(emp, order_date, order_type, customer.value, customer_phone.value, delivery,
                                                receipt_date.value, receipt_hour, pay_price.value, pay_check, pay_type,
                                                recipient.value, recipient_phone.value, address1, address2, memo, productList);

            let data = {"pno" : currentPno, "order" : virtual_order, "update" : pno, "delete" : deletenum};
            let jsonData = JSON.stringify(data);

            $.ajaxSetup({
                beforeSend:function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
            $.ajax({
                type:'POST',
                url:'/list/update',
                data:jsonData,
                dataType:'json',
                contentType:'application/json; charset=utf-8',
                success:function(result) {
                    if(result.alarm !== '') {
                        alert(result.alarm);
                    } else {
                        alert(result.order);
                    }
                    location.href='/';
                },
                error:function(xhr, status, error) {
                    console.log(xhr+status+error);
                }
            });
        }
    </script>
{% endblock javascript %}